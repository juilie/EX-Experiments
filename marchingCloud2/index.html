<!DOCTYPE html>
<html lang="en">
	<head>
		<title>EX Research</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
		<link rel="stylesheet" href="https://unpkg.com/7.css">
		<style>

			@font-face {
				font-family: 'ff7';
				src: url('assets/Final_Fantasy_VII.ttf') format('truetype');
			}

			html, body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				width: 100%;
				height: 100%;
				background-color: white;
			}


			
			#homepage-ui {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				z-index: 200;
				pointer-events: none;
				font-family: 'Arial Narrow', monospace;
			}

			.agency-card {
				max-width: 480px;
				width: 90%;
				pointer-events: auto;
				animation: cardPopIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
				transform: scale(0);
				animation-delay: 0.3s;
				background-color: #ffffff;
				/* subtle inward fades toward the black before/after tabs */
				background: linear-gradient(to bottom, #000000 0%, #ffffff 5%, #ffffff 95%, #000000 100%);
				border: 1px solid black;
				border-radius: 8px;
				border-top-right-radius: 0;
				border-bottom-left-radius: 0;
				position: relative;
				/* overflow: hidden; */
			}

			.agency-card::before {
				content: '';
				text-align: right;
				background-color: black;
				padding: 0 12px;
				font-size: 8px;
				display: flex;
				align-items: center;
				justify-content: right;
				position: absolute;
				border-radius: 10px 10px 0 0;
				top: -20px;
				right: -1px;
				border: none;
				width:120px;
				height: 21px;
				box-sizing: border-box;
				z-index: -1;
				clip-path: polygon(18% 0, 100% 0, 100% 100%, 0% 100%);
			}

			.agency-card::after {
				content: '';
				text-align: right;
				background-color: black;
				padding: 0 12px;
				font-size: 8px;
				display: flex;
				align-items: center;
				justify-content: right;
				position: absolute;
				border-radius: 0px 0px 10px 10px;
				bottom: -20px;
				left: -1px;
				border: none;
				width:120px;
				height: 21px;
				box-sizing: border-box;
				z-index: -1;
				clip-path: polygon( 0 0, 100% 0, 82% 100%, 0% 100%);
			}

			.card-body {
				padding: 32px;
				text-align: center;
			}


			#enter-button {
				background: #c0c0c0; /* classic gray */
				color: #000000;
				padding: 12px 28px;
				font-size: 14px;
				font-weight: 700;
				letter-spacing: 0.02em;
				text-transform: none;
				border-radius: 0;
				cursor: pointer;
				position: relative;
				border: 2px solid #ffffff; /* top/left light */
				border-right-color: #404040; /* right dark */
				border-bottom-color: #404040; /* bottom dark */
				box-shadow:
					inset 1px 1px 0 #dfdfdf,
					inset -1px -1px 0 #808080,
					0 0 0 1px #000000; /* outer black keyline like old UI */
				transition: background-color .12s ease;
			}

			#enter-button:hover {
				background: #dcdcdc;
			}

			#enter-button:active {
				background: #b5b5b5;
				border-color: #404040; /* top/left dark when pressed */
				border-right-color: #ffffff; /* right/bottom light when pressed */
				border-bottom-color: #ffffff;
				box-shadow:
					inset -1px -1px 0 #dfdfdf,
					inset 1px 1px 0 #808080,
					0 0 0 1px #000000;
			}

			#enter-button:focus {
				outline: 1px dotted #000000;
				outline-offset: 2px;
			}
			
			#main-title {
				font-size: 60px;
				font-weight: 300;
				color: #000000;
				margin: 0 0 24px 0;
				font-family: 'Arial Narrow', monospace;
				line-height: 1.1;
				display: flex;
				align-items: baseline;
				justify-content: center;
				flex-wrap: wrap;
				letter-spacing: -1px;
			}

			.letter {
				display: inline-block;
				transition: transform 0.3s ease;
			}

			.letter.small {
				font-size: 0.6em;
				font-weight: normal;
			}

			.letter.medium {
				font-size: 0.8em;
				font-weight:900;
			}
			.letter.medium-light {
				font-size: 0.8em;
				font-weight:100;
			}

			.letter.medium-light {
				transform: scale(1.2) rotate(-5deg);
				color: #ff0080;
				font-weight: 900 !important;
			}

			.letter.big {
				font-size: 1em;
				font-weight: 900;
			}

			.letter.huge {
				font-size: 1.3em;
				font-weight: 900;
			}

			.letter:hover {
				transform: scale(1.2) rotate(-5deg);
				color: #0066cc;
			}

			@keyframes cardPopIn {
				0% {
					transform: scale(0) rotateY(-10deg);
					opacity: 0;
				}
				50% {
					transform: scale(1.05) rotateY(0deg);
					opacity: 1;
				}
				100% {
					transform: scale(1) rotateY(0deg);
					opacity: 1;
				}
			}
			
			#subtitle {
				font-size: 20px;
				color: black;
				margin: 0 0 32px 0;
				line-height: 1.5;
				font-weight: 400;
				font-style: italic;
			}
			
			.hidden {
				display: none !important;
			}
			
			.cloud-image {
				position: fixed;
				z-index: 150;
				pointer-events: none;
				transform-origin: center center;
				opacity: 1;
				filter: brightness(1.1) contrast(1.1);
			}
			
			.hud-scanner {
				position: fixed;
				width: 20px;
				height: 20px;
				border: 2px solid #4a90e2;
				background: rgba(74, 144, 226, 0.15);
				z-index: 160;
				pointer-events: none;
				transition: all 0.4s ease;
				box-shadow: 
					0 0 8px rgba(74, 144, 226, 0.4),
					inset 0 0 8px rgba(74, 144, 226, 0.2);
			}
			
			.hud-scanner.scanning {
				border-color: #2ecc71;
				background: rgba(46, 204, 113, 0.15);
				box-shadow: 
					0 0 15px rgba(46, 204, 113, 0.6),
					inset 0 0 10px rgba(46, 204, 113, 0.3);
			}
			
			.hud-scanner::before {
				content: '';
				position: absolute;
				top: 50%;
				left: 50%;
				width: 6px;
				height: 6px;
				background: currentColor;
				border-radius: 50%;
				transform: translate(-50%, -50%);
				box-shadow: 0 0 4px currentColor;
			}
			
			.hud-scanner::after {
				content: attr(data-status);
				position: absolute;
				bottom: -35px;
				right: -50px;
				font-family: 'Epmarugo', monospace;
				font-size: 10px;
				color: black;
				white-space: nowrap;
				font-weight: bold;
				text-shadow: 1px 1px 0px white, -1px -1px 0px white, 1px -1px 0px white, -1px 1px 0px white;
			}
			

			.hud-scanner-frame {
				position: absolute;
				top: -3px;
				left: -3px;
				right: -3px;
				bottom: -3px;
				border: 1px solid currentColor;
				opacity: 0.6;
				pointer-events: none;
			}
			
			.hud-scanner-corners {
				position: absolute;
				top: -6px;
				left: -6px;
				right: -6px;
				bottom: -6px;
				pointer-events: none;
			}
			
			.hud-scanner-corners::before,
			.hud-scanner-corners::after {
				content: '';
				position: absolute;
				width: 8px;
				height: 8px;
				border: 1px solid black;
				opacity: 0.8;
			}
			
			.hud-scanner-corners::before {
				top: 0;
				left: 0;
				border-right: none;
				border-bottom: none;
			}
			
			.hud-scanner-corners::after {
				bottom: 0;
				right: 0;
				border-left: none;
				border-top: none;
			}


			
		</style>
	</head>
	<body>
		<div id="homepage-ui">
			<div class="agency-card">
				<div class="card-body">
					<h1 id="main-title">
						<span class="letter medium-light">EX</span>
						<span class="letter small">&nbsp;</span>
						<span class="letter medium">R</span><span class="letter medium">e</span><span class="letter medium">s</span><span class="letter medium">e</span><span class="letter medium">a</span><span class="letter medium">r</span><span class="letter medium">c</span><span class="letter medium">h</span>
					</h1>
					<p id="subtitle">The world's most online agency.</p>
					<button id="enter-button">ENTER</button>
				</div>
			</div>
		</div>

		<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.158.0/build/three.module.js",
					"three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
				}
			}
		</script>

		

		<script type="module">
			import * as THREE from 'three';
			import { MarchingCubesScene } from './threejs-marching.js';
			import { Chatboxes2D } from './chatboxes-2d.js';

			let container;
			let marchingScene;
			let chatboxesScene;

			// Cloud shader setup
			let cloudRenderer, cloudScene, cloudCamera, cloudMesh;
			let lastCloudRenderTime = 0;
			let cloudFrameIntervalMs = 50; // ~20 FPS for clouds
			const CloudShader = {
				uniforms: {
					'time': { value: 0.0 },
					'resolution': { value: new THREE.Vector2() }
				},
				vertexShader: `
					varying vec2 vUv;
					void main() {
						vUv = uv;
						gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
					}
				`,
				fragmentShader: `
					uniform float time;
					uniform vec2 resolution;
					varying vec2 vUv;

					const float cloudscale = 0.8;
					const float speed = 0.02;
					const float clouddark = 0.4;
					const float cloudlight = 0.4;
					const float cloudcover = 0.3;
					const float cloudalpha = 6.0;
					const float skytint = 0.6;
					const vec3 skycolour1 = vec3(0.15, 0.3, 0.5);
					const vec3 skycolour2 = vec3(0.3, 0.6, 0.9);

					const mat2 m = mat2( 1.6,  1.2, -1.2,  1.6 );

					vec2 hash( vec2 p ) {
						p = vec2(dot(p,vec2(127.1,311.7)), dot(p,vec2(269.5,183.3)));
						return -1.0 + 2.0*fract(sin(p)*43758.5453123);
					}

					float noise( in vec2 p ) {
						const float K1 = 0.366025404; // (sqrt(3)-1)/2;
						const float K2 = 0.211324865; // (3-sqrt(3))/6;
						vec2 i = floor(p + (p.x+p.y)*K1);
						vec2 a = p - i + (i.x+i.y)*K2;
						vec2 o = (a.x>a.y) ? vec2(1.0,0.0) : vec2(0.0,1.0);
						vec2 b = a - o + K2;
						vec2 c = a - 1.0 + 2.0*K2;
						vec3 h = max(0.5-vec3(dot(a,a), dot(b,b), dot(c,c) ), 0.0 );
						vec3 n = h*h*h*h*vec3( dot(a,hash(i+0.0)), dot(b,hash(i+o)), dot(c,hash(i+1.0)));
						return dot(n, vec3(70.0));
					}

					float fbm(vec2 n) {
						float total = 0.0, amplitude = 0.1;
						for (int i = 0; i < 7; i++) {
							total += noise(n) * amplitude;
							n = m * n;
							amplitude *= 0.4;
						}
						return total;
					}

					void main() {
						vec2 p = vUv;
						vec2 uv = p*vec2(resolution.x/resolution.y,1.0);
						float t = time * speed;
						float q = fbm(uv * cloudscale * 0.5);

						float r = 0.0;
						uv *= cloudscale;
						uv -= q - t;
						float weight = 0.8;
						for (int i=0; i<8; i++){
							r += abs(weight*noise( uv ));
							uv = m*uv + t;
							weight *= 0.7;
						}

						float f = 0.0;
						uv = p*vec2(resolution.x/resolution.y,1.0);
						uv *= cloudscale;
						uv -= q - t;
						weight = 0.7;
						for (int i=0; i<8; i++){
							f += weight*noise( uv );
							uv = m*uv + t;
							weight *= 0.6;
						}

						f *= r + f;

						float c = 0.0;
						float t2 = time * speed * 2.0;
						uv = p*vec2(resolution.x/resolution.y,1.0);
						uv *= cloudscale*2.0;
						uv -= q - t2;
						weight = 0.4;
						for (int i=0; i<7; i++){
							c += weight*noise( uv );
							uv = m*uv + t2;
							weight *= 0.6;
						}

						float c1 = 0.0;
						float t3 = time * speed * 3.0;
						uv = p*vec2(resolution.x/resolution.y,1.0);
						uv *= cloudscale*3.0;
						uv -= q - t3;
						weight = 0.4;
						for (int i=0; i<7; i++){
							c1 += abs(weight*noise( uv ));
							uv = m*uv + t3;
							weight *= 0.6;
						}

						c += c1;

						vec3 skycolour = mix(skycolour2, skycolour1, p.y);
						vec3 cloudcolour = vec3(1.1, 1.1, 0.9) * clamp((clouddark + cloudlight*c), 0.0, 1.0);
						f = cloudcover + cloudalpha*f*r;
						vec3 result = mix(skycolour, clamp(skytint * skycolour + cloudcolour, 0.0, 1.0), clamp(f + c, 0.0, 1.0));
						gl_FragColor = vec4( result, 1.0 );
					}
				`
			};

			// Initialize the application
			init();

			function init() {
				// Create container for Three.js scene
				container = document.createElement('div');
				container.style.position = 'fixed';
				container.style.top = '0';
				container.style.left = '0';
				container.style.zIndex = '1';
				document.body.appendChild(container);

				// Create background cloud renderer (behind main scene)
				cloudRenderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
				cloudRenderer.setPixelRatio(Math.max(1, Math.min(window.devicePixelRatio, 1.5) * 0.5));
				cloudRenderer.setSize(window.innerWidth, window.innerHeight);
				cloudRenderer.domElement.style.position = 'fixed';
				cloudRenderer.domElement.style.top = '0';
				cloudRenderer.domElement.style.left = '0';
				cloudRenderer.domElement.style.zIndex = '0';
				document.body.insertBefore(cloudRenderer.domElement, container);

				cloudScene = new THREE.Scene();
				cloudCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
				const plane = new THREE.PlaneGeometry(2, 2);
				const cloudMaterial = new THREE.ShaderMaterial({
					uniforms: CloudShader.uniforms,
					vertexShader: CloudShader.vertexShader,
					fragmentShader: CloudShader.fragmentShader
				});
				cloudMesh = new THREE.Mesh(plane, cloudMaterial);
				cloudScene.add(cloudMesh);
				CloudShader.uniforms.resolution.value.set(window.innerWidth, window.innerHeight);

				// Initialize the Three.js marching cubes scene
				marchingScene = new MarchingCubesScene(container);

				// Initialize the 2D chatboxes scene
				chatboxesScene = new Chatboxes2D();

				// Initialize default control values
				window.chatboxControls = {
					visible: true,
					speed: 2.0,
					connectionDistance: 12.0,
					spawnRate: 2.0,
					pixelation: 2,
					style: 'classic' // 'classic' or 'ff7'
				};

				window.cloudControls = {
					enabled: true,
					spawnRate: 0.5, // clouds per second
					scannerCount: 4
				};
				
				window.cloudDebug = {
					status: 'Waiting...'
				};

				// Set up the main render loop that coordinates both scenes
				function animate() {
					// Render the Three.js scene
					marchingScene.render();

					// Render clouds background at reduced frame rate
					const now = performance.now();
					if (now - lastCloudRenderTime >= cloudFrameIntervalMs) {
						CloudShader.uniforms.time.value = (now * 0.001);
						cloudRenderer.render(cloudScene, cloudCamera);
						lastCloudRenderTime = now;
					}

					// Draw 2D chatboxes overlay
					if (window.chatboxControls && window.chatboxControls.visible) {
						chatboxesScene.drawChatboxes();
					}
				}

				// Start the animation loop
				marchingScene.getRenderer().setAnimationLoop(animate);

				// Handle window resize
				window.addEventListener('resize', () => {
					marchingScene.onWindowResize();
					chatboxesScene.onWindowResize();
					if (cloudRenderer) {
						cloudRenderer.setSize(window.innerWidth, window.innerHeight);
						cloudRenderer.setPixelRatio(Math.max(1, Math.min(window.devicePixelRatio, 1.5) * 0.5));
						CloudShader.uniforms.resolution.value.set(window.innerWidth, window.innerHeight);
					}
				});
			}

		</script>
	</body>
</html>